import { LoginStateService } from '../common/service/LoginStateService'
import { RcpUtilsService, MemberLevel, RightCategory, RightItem } from '../common/service/RcpUtilsService'
import MainPageViewModel, { MineIcon } from '../viewmodel/MainPageViewModel'


@Component
export struct MinePage {
  @StorageProp('topSafeHeight') topSafeHeight: number = 0
  @StorageProp('bottomSafeHeight') bottomSafeHeight: number = 0
  @State isLoading: boolean = true
  @StorageLink('userName') userName: string = ''
  @StorageLink('userPhone') userPhone: string = ''
  @StorageLink('userAvatar') userAvatar: string = ''
  @StorageLink('userLevelType') userLevelType: number = 0
  @State memberLevels: MemberLevel[] = []
  @State levelSwiperIndex: number = 0
  @State rightsOfActiveLevel: RightItem[] = []
  @State rightCategories: RightCategory[] = []
  @State activeCategory: number = 0
  @State rightsByCategory: RightItem[] = []
  @State unlockedCount: number = 0
  @State userGrowthValue: number = 0
  @State userCoins: number = 0
  @State levelGrowthMin: number = 0
  @State levelGrowthMax: number = 100
  @State levelProgress: number = 0 // 0~1
  @State currentLevelName: string = ''
  @State nextLevelName: string = ''
  
  // ç­¾åˆ°ç›¸å…³çŠ¶æ€
  @State canSignIn: boolean = true
  @State lastSignInDate: string = ''
  @State showSignInDialog: boolean = false
  @State earnedCoins: number = 0
  
  @Consume('pathStack') pathStack: NavPathStack

  aboutToAppear() {
    this.initFromLoginState()
    this.loadAll()
    this.checkSignInStatus()
  }

  onPageShow() {
    console.info('MinePage: é¡µé¢é‡æ–°æ˜¾ç¤ºï¼ŒåŒæ­¥ç”¨æˆ·ä¿¡æ¯')
    this.initFromLoginState()
    this.checkSignInStatus()
  }

  initFromLoginState() {
    LoginStateService.syncStorageData()
  }

  // æ£€æŸ¥ç­¾åˆ°çŠ¶æ€
  checkSignInStatus() {
    const today = new Date().toDateString()
    const lastSignIn = LoginStateService.getLastSignInDate()
    
    if (lastSignIn === today) {
      this.canSignIn = false
      this.lastSignInDate = lastSignIn
    } else {
      this.canSignIn = true
      this.lastSignInDate = ''
    }
  }

  // æ‰§è¡Œç­¾åˆ°
  async performSignIn() {
    if (!this.canSignIn) {
      return
    }

    try {
      const userId = LoginStateService.getUserId()
      if (!userId) {
        console.error('ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•ç­¾åˆ°')
        return
      }

      // ç”Ÿæˆéšæœºé›ªçŽ‹å¸ (10-50ä¹‹é—´)
      const randomCoins = Math.floor(Math.random() * 41) + 10
      this.earnedCoins = randomCoins

      // æ›´æ–°ç”¨æˆ·é›ªçŽ‹å¸
      await RcpUtilsService.incrementUserStats(userId, randomCoins, 0)

      // è®°å½•ç­¾åˆ°æ—¥æœŸ
      const today = new Date().toDateString()
      LoginStateService.setLastSignInDate(today)
      
      // æ›´æ–°ç­¾åˆ°çŠ¶æ€
      this.canSignIn = false
      this.lastSignInDate = today

      // æ›´æ–°æœ¬åœ°é›ªçŽ‹å¸æ•°é‡
      this.userCoins += randomCoins

      // æ˜¾ç¤ºç­¾åˆ°æˆåŠŸå¼¹çª—
      this.showSignInDialog = true

      // åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
      await this.loadUserGrowthInfo()

    } catch (error) {
      console.error('ç­¾åˆ°å¤±è´¥:', error)
    }
  }



  async loadAll() {
    try {
      this.isLoading = true
      await this.loadLevelsAndRights()
      await this.loadRightCategoriesAndList()
      await this.loadUserGrowthInfo()
    } finally {
      this.isLoading = false
    }
  }

  async loadLevelsAndRights() {
    const levels = await RcpUtilsService.fetchMemberLevels()
    this.memberLevels = levels

    const idx = levels.findIndex(l => l.level_type === this.userLevelType)
    this.levelSwiperIndex = idx >= 0 ? idx : 0

    await this.reloadRightsForCurrentLevel()
  }

  async loadRightCategoriesAndList() {
    const cats = await RcpUtilsService.fetchRightCategories()
    this.rightCategories = cats
    if (cats && cats.length > 0) {
      this.activeCategory = cats[0].category
      await this.loadRightsByCategory(this.activeCategory)
    } else {
      this.activeCategory = 0
      this.rightsByCategory = []
    }
  }

  async loadRightsByCategory(category: number) {
    this.activeCategory = category
    this.rightsByCategory = await RcpUtilsService.fetchRightsByCategory(category)
  }

  async loadUserGrowthInfo() {
    try {
      if (this.userPhone) {
        const user = await RcpUtilsService.getUserByPhone(this.userPhone)
        if (user) {
          this.userGrowthValue = Number(user.growth_value ?? 0)
          this.userCoins = Number(user.coins ?? 0)
          await this.updateLevelProgress()
        }
      }
    } catch (error) {
      console.error('MinePage: èŽ·å–ç”¨æˆ·æˆé•¿å€¼å¤±è´¥:', error)
    }
  }

  async updateLevelProgress() {
    try {
      if (this.memberLevels && this.memberLevels.length > 0) {
        const currentLevel = this.memberLevels.find(l => l.level_type === this.userLevelType)
        if (currentLevel) {
          this.currentLevelName = currentLevel.name || ''
          this.levelGrowthMin = Number(currentLevel.growth_value_min ?? 0)
          this.levelGrowthMax = Number(currentLevel.growth_value_max ?? 100)
          
          const min: number = Math.max(0, this.levelGrowthMin)
          const max: number = Math.max(min + 1, this.levelGrowthMax)
          const gv: number = Math.max(0, this.userGrowthValue)
          const ratio: number = Math.min(1, Math.max(0, (gv - min) / (max - min)))
          this.levelProgress = ratio

          if (ratio >= 1 && this.userLevelType > 0) {
            await this.tryPromoteLevel()
          }

          const currentIndex = this.memberLevels.findIndex(l => l.level_type === this.userLevelType)
          if (currentIndex >= 0 && currentIndex + 1 < this.memberLevels.length) {
            this.nextLevelName = this.memberLevels[currentIndex + 1].name || ''
          } else {
            this.nextLevelName = ''
          }
        }
      }
    } catch (error) {
      console.error('MinePage: æ›´æ–°ç­‰çº§è¿›åº¦å¤±è´¥:', error)
    }
  }

  async tryPromoteLevel() {
    try {
      const levels = await RcpUtilsService.fetchMemberLevels()
      const idx = levels.findIndex(l => l.level_type === this.userLevelType)
      const next = idx >= 0 && idx + 1 < levels.length ? levels[idx + 1] : null
      if (next) {
        const userId = LoginStateService.getUserId()
        if (userId) {
          const updated = await RcpUtilsService.updateUserLevel(userId, next.level_type)
          if (updated) {
            LoginStateService.setUserLevelType(next.level_type)
            this.userLevelType = next.level_type
            this.levelSwiperIndex = idx + 1
            await this.reloadRightsForCurrentLevel()
            await this.updateLevelProgress()
          }
        }
      }
    } catch (error) {
      console.error('MinePage: ç­‰çº§å‡çº§å¤±è´¥:', error)
    }
  }

  async reloadRightsForCurrentLevel() {
    const rights = await RcpUtilsService.fetchRightsByLevel(this.userLevelType)
    this.unlockedCount = rights.length
    this.rightsOfActiveLevel = rights

    try {
      const mainRights = await RcpUtilsService.fetchMainRightsByLevel(this.userLevelType)
      this.rightsByCategory = mainRights
    } catch (_e) {
      this.rightsByCategory = rights.slice(0, 10)
    }

    try {
      const cats = await RcpUtilsService.fetchRightCategories()
      this.rightCategories = cats
      if (cats && cats.length > 0) {
        this.activeCategory = cats[0].category
        this.rightsByCategory = await RcpUtilsService.fetchRightsByCategory(this.activeCategory)
      } else {
        this.activeCategory = 0
      }
    } catch (_e) {
    }
  }

  async onLevelIndexChange(index: number) {
    this.levelSwiperIndex = index
    const selected = this.memberLevels[index]
    if (selected) {
      this.userLevelType = selected.level_type
      await this.reloadRightsForCurrentLevel()
      await this.updateLevelProgress()
    }
  }

  private getLevelBg(levelType: number): string {
    switch (levelType) {
      case 1:
        return '#4AA8FF'
      case 2:
        return '#FFA726'
      case 3:
        return '#9C6CFF'
      case 4:
        return '#2B2623'
      default:
        return '#FFA726'
    }
  }

  @Builder
  levelCard(level: MemberLevel) {
    Column() {
      Column() {
        Text(level.name || 'ä¼šå‘˜')
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFF')
          .alignSelf(ItemAlign.Start)

        Text(level.current_level_txt ? level.current_level_txt :
          (level.next_level_txt ? `å‡çº§å¯äº«ã€${level.next_level_txt}ã€‘ç­‰æƒç›Š` : ''))
          .fontSize(14)
          .fontColor('#FFFFFFCC')
          .margin({ top: 6 })
          .alignSelf(ItemAlign.Start)
      }
      .width('100%')
      .alignItems(HorizontalAlign.End)

      Image($r('app.media.ic_gift')).width(80).height(80).alignSelf(ItemAlign.End)

    }
    .padding(16)
    .backgroundColor(this.getLevelBg(level.level_type))
    .borderRadius(12)
  }

  @Builder
  levelProgressBuilder() {
    Column() {
      Row() {
        Text('ç­‰çº§è¿›åº¦')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333')
        Blank().layoutWeight(1)
        Text(`${this.currentLevelName} â†’ ${this.nextLevelName || 'å·²æ»¡çº§'}`)
          .fontSize(12)
          .fontColor('#999')
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 16, bottom: 8 })

      Row() {
        Text('æˆé•¿å€¼')
          .fontSize(14)
          .fontColor('#666')
        Blank().layoutWeight(1)
        Text(`${this.userGrowthValue}`)
          .fontSize(14)
          .fontColor('#333')
          .fontWeight(FontWeight.Medium)
      }
      .width('100%')
      .padding({ left: 16, right: 16, bottom: 8 })

      Row() {
        Blank()
          .height(8)
          .layoutWeight(1)
          .backgroundColor('#F0F0F0')
          .borderRadius(4)
        
        Row() { Blank() }
          .height(8)
          .width(`${Math.round(this.levelProgress * 100)}%`)
          .backgroundColor('#FFA726')
          .borderRadius(4)
          .position({ x: 0 })
      }
      .width('100%')
      .padding({ left: 16, right: 16, bottom: 16 })

      if (this.levelProgress >= 1 && this.nextLevelName) {
        Row() {
          Text('ðŸŽ‰ æ­å–œï¼å·²è¾¾åˆ°å‡çº§æ¡ä»¶')
            .fontSize(14)
            .fontColor('#FF6B35')
            .fontWeight(FontWeight.Medium)
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .padding({ bottom: 16 })
      }
    }
    .width('100%')
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ top: 10 })
  }

  @Builder
  rightItemCard(item: RightItem) {
    Column() {
      Image(item.image || $r('app.media.ic_gift'))
        .width(32).height(32).margin({ bottom: 8 })
      Text(item.name)
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
      if (item.assistDesc) {
        Text(item.assistDesc)
          .fontSize(12)
          .fontColor('#777777')
          .margin({ top: 2 })
      }
    }
    .width(96)
    .height(96)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .margin({ right: 12 })
  }

  @Builder
  otherServices() {
    Column() {
      Row() {
        Text('å…¶ä»–æœåŠ¡')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333')
        Blank().layoutWeight(1)
      }
      .width('100%')
      .padding({
        left: 16,
        right: 16,
        top: 16,
        bottom: 12
      })

      Grid() {
        ForEach(MainPageViewModel.getMineIcon(), (item: MineIcon) => {
          GridItem() {
            this.serviceItem(item)
          }
        }, (item: MineIcon, index: number) => JSON.stringify(index + item.id))
      }
      .columnsTemplate('1fr 1fr 1fr 1fr')
      .columnsGap(16)
      .rowsGap(16)
      .padding({ left: 16, right: 16, bottom: 16 })
    }
    .width('100%')
    .backgroundColor(Color.White)
    .margin({ top: 10 })
  }

  @Builder
  serviceItem(item: MineIcon) {
    Column() {
      Row() {
        Image(item.image)
          .width(18)
          .aspectRatio(1)
          .fillColor('#666666')
      }
      .justifyContent(FlexAlign.Center)
      .alignItems(VerticalAlign.Center)
      .margin({ bottom: 8 })

      Text(item.title)
        .fontSize(14)
        .fontColor('#333333')
        .fontWeight(FontWeight.Medium)
    }
    .width('100%')
    .alignItems(HorizontalAlign.Center)
    .padding({ top: 12, bottom: 12 })
    .onClick(() => {
      if (item.id === 1) {
        this.pathStack.pushPathByName("Setting", null)
      } else {
        console.info(`ç‚¹å‡»äº†${item.title}`)
      }
    })
  }

  build() {
    Column() {
      Row() {
        Image(this.userAvatar || $r('app.media.ic_mine_new_selected'))
          .width(40).height(40).borderRadius(20)
          .backgroundColor('#EEE')
        Column() {
          Text(this.userName || this.userPhone || 'æœªç™»å½•')
            .fontSize(18).fontWeight(FontWeight.Medium).fontColor('#222')
          if (this.userPhone) {
            Text(this.userPhone)
              .fontSize(12).fontColor('#999').margin({ top: 2 })
          }
        }
        .margin({ left: 6 })
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        Button(this.canSignIn ? 'ç­¾åˆ°' : 'å·²ç­¾åˆ°')
          .width(60)
          .height(28)
          .fontSize(12)
          .fontColor(this.canSignIn ? '#666' : '#999')
          .backgroundColor(this.canSignIn ? '#FFF' : '#F5F5F5')
          .border({ width: 1, color: this.canSignIn ? '#E0E0E0' : '#E0E0E0' })
          .borderRadius(14)
          .onClick(() => this.performSignIn())
          .enabled(this.canSignIn)
      }
      .width('100%')
      .padding({
        left: 16,
        right: 16,
        top: 16 + this.getUIContext().px2vp(this.topSafeHeight),
        bottom: 12
      })
      .backgroundColor(Color.White)

      Column() {
        if (this.memberLevels && this.memberLevels.length > 0) {
          Swiper() {
            ForEach(this.memberLevels, (lv: MemberLevel) => {
              Row() {
                this.levelCard(lv)
              }
            })
          }
          .index(this.levelSwiperIndex)
          .autoPlay(false)
          .loop(false)
          .indicator(false)
          .onChange((idx: number) => {
            this.onLevelIndexChange(idx)
          })
          .width('100%')
          .height(190)
          .padding({ left: 12, right: 12 })
        }
      }
      .width('100%')
      .backgroundColor('#FFF6E6')

      this.levelProgressBuilder()

      Column() {
        Row() {
          Text('ä¼šå‘˜æƒç›Š')
            .fontSize(16).fontWeight(FontWeight.Medium).fontColor('#333')
          Blank().layoutWeight(1)
          Text(`å·²è§£é”${this.unlockedCount}é¡¹ >`).fontSize(12).fontColor('#999')
        }
        .width('100%')
        .padding({
          left: 12,
          right: 12,
          top: 8,
          bottom: 6
        })

        Row({ space: 10 }) {
          ForEach(this.rightCategories, (c: RightCategory) => {
            Text(c.category_name)
              .fontSize(14)
              .fontColor(this.activeCategory === c.category ? '#fff' : '#666')
              .backgroundColor(this.activeCategory === c.category ? '#FFA726' : '#F1F1F1')
              .padding({
                left: 12,
                right: 12,
                top: 6,
                bottom: 6
              })
              .borderRadius(16)
              .onClick(() => this.loadRightsByCategory(c.category))
          })
        }
        .width('100%')
        .padding({ left: 12, right: 12, bottom: 8 })

        List() {
          ForEach(this.rightsByCategory, (r: RightItem) => {
            ListItem() {
              this.rightItemCard(r)
            }
          })
        }
        .listDirection(Axis.Horizontal)
        .scrollBar(BarState.Off)
        .width('100%')
        .height(120)
        .padding({ left: 12, right: 12 })
      }
      .width('100%')
      .backgroundColor(Color.White)
      .margin({ top: 10 })

      this.otherServices()

      Blank().layoutWeight(1)

      // ç­¾åˆ°å¼¹çª—
      if (this.showSignInDialog) {
        Stack() {
          Column() {
            Column() {
              Image($r('app.media.ic_gift'))
                .width(60)
                .height(60)
                .margin({ bottom: 16 })

              Text('ç­¾åˆ°æˆåŠŸï¼')
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .fontColor('#333')
                .margin({ bottom: 8 })

              Text(`æ­å–œèŽ·å¾— ${this.earnedCoins} è¿ªå¥¥å¸`)
                .fontSize(16)
                .fontColor('#FF6B35')
                .fontWeight(FontWeight.Medium)
                .margin({ bottom: 24 })

              Button('ç¡®å®š')
                .width(120)
                .height(40)
                .fontSize(16)
                .fontColor(Color.White)
                .backgroundColor('#C8A07B')
                .borderRadius(20)
                .onClick(() => {
                  this.showSignInDialog = false
                })
            }
            .width(280)
            .padding(24)
            .backgroundColor(Color.White)
            .borderRadius(16)
            .alignItems(HorizontalAlign.Center)
          }
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0, 0, 0, 0.5)')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .onClick(() => {
            this.showSignInDialog = false
          })
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })
        .zIndex(999)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
    .padding({ bottom: this.getUIContext().px2vp(this.bottomSafeHeight) })
  }
}